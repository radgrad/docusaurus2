(window.webpackJsonp=window.webpackJsonp||[]).push([[196],{252:function(e,t,o){"use strict";o.r(t),o.d(t,"frontMatter",(function(){return l})),o.d(t,"metadata",(function(){return i})),o.d(t,"rightToc",(function(){return s})),o.d(t,"default",(function(){return d}));var a=o(2),n=o(6),r=(o(0),o(345)),l={title:"Update to a new major release of Mongo",sidebar_label:"Update Mongo"},i={unversionedId:"developers/deployment/howto/update-mongo-mup",id:"developers/deployment/howto/update-mongo-mup",isDocsHomePage:!1,title:"Update to a new major release of Mongo",description:"In February, 2022, Meteor released a new version (2.6) that necessitated upgrading to a new major version of Mongo (5.0) from our current version (3.1.4).  This was basically impossible to do in an incremental fashion, so we were forced to make a backup of the database, reinstall Mongo from scratch, and redeploy and reinitialize the database.",source:"@site/docs/developers/deployment/howto/update-mongo-mup.md",slug:"/developers/deployment/howto/update-mongo-mup",permalink:"/docs/developers/deployment/howto/update-mongo-mup",version:"current",lastUpdatedBy:"Philip Johnson",lastUpdatedAt:1644871367,sidebar_label:"Update Mongo",sidebar:"mainSidebar",previous:{title:"Reset the database",permalink:"/docs/developers/deployment/howto/reset-db"},next:{title:"mup commands",permalink:"/docs/developers/deployment/reference/mup-commands"}},s=[{value:"Make a backup of the database",id:"make-a-backup-of-the-database",children:[]},{value:"Update mup to the latest release",id:"update-mup-to-the-latest-release",children:[]},{value:"Shut down the production system",id:"shut-down-the-production-system",children:[]},{value:"Delete the MongoDB installation",id:"delete-the-mongodb-installation",children:[]},{value:"Redeploy and reload the database",id:"redeploy-and-reload-the-database",children:[]}],p={rightToc:s};function d(e){var t=e.components,o=Object(n.a)(e,["components"]);return Object(r.b)("wrapper",Object(a.a)({},p,o,{components:t,mdxType:"MDXLayout"}),Object(r.b)("p",null,"In February, 2022, Meteor released a new version (2.6) that necessitated upgrading to a new major version of Mongo (5.0) from our current version (3.1.4).  This was basically impossible to do in an incremental fashion, so we were forced to make a backup of the database, reinstall Mongo from scratch, and redeploy and reinitialize the database. "),Object(r.b)("p",null,"This process was sufficiently complicated that it seems useful to document how to do this in case a similar situation occurs in future."),Object(r.b)("h2",{id:"make-a-backup-of-the-database"},"Make a backup of the database"),Object(r.b)("p",null,"Login as admin, and use the database management page to download a JSON file containing a dump of the database. "),Object(r.b)("p",null,"This is necessary because you will need to delete the deployed database as part of the upgrade procedure."),Object(r.b)("h2",{id:"update-mup-to-the-latest-release"},"Update mup to the latest release"),Object(r.b)("p",null,"Make sure you are running the latest release of mup:"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{}),"$ npm install mup -g\n$ mup --version\n")),Object(r.b)("p",null,"It should be at least 1.5.7."),Object(r.b)("h2",{id:"shut-down-the-production-system"},"Shut down the production system"),Object(r.b)("p",null,"Invoke the following to shutdown both the Meteor application and MongoDB:"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{}),"$ mup stop\n$ mup mongo stop\n")),Object(r.b)("p",null,"If you want, you can also completely remove the Meteor application with:"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{}),"$ mup meteor destroy\n")),Object(r.b)("h2",{id:"delete-the-mongodb-installation"},"Delete the MongoDB installation"),Object(r.b)("p",null,"In the current case, we had to update MongoDB from 3.2 to 5.0.  This was too much of a jump, so the most efficient approach was to completely delete the MongoDB installation and then reload the database from scratch.  Here's how to delete MongoDB from the server:"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{}),"$ ssh <user@radgrad-server>\n$ rm -rf /opt/mongodb\n$ rm -rf /var/lib/mongodb\n")),Object(r.b)("h2",{id:"redeploy-and-reload-the-database"},"Redeploy and reload the database"),Object(r.b)("p",null,'Edit your settings.json file\'s "databaseRestoreFileName" field to point to your backup copy of the database.'),Object(r.b)("p",null,"Edit the mup.js file to specify the appropriate version of MongoDB."),Object(r.b)("p",null,"Run the following to redeploy:"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{}),"$ mup setup\n$ mup deploy\n")),Object(r.b)("p",null,"Occasionally ",Object(r.b)("inlineCode",{parentName:"p"},"mup setup")," will fail. Try one more time, it might succeed on the second try."),Object(r.b)("p",null,"Since you are redeploying the database, you will get a new admin password. Be sure to save it when it is printed to the console."))}d.isMDXComponent=!0},345:function(e,t,o){"use strict";o.d(t,"a",(function(){return c})),o.d(t,"b",(function(){return m}));var a=o(0),n=o.n(a);function r(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function l(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,a)}return o}function i(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?l(Object(o),!0).forEach((function(t){r(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):l(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}function s(e,t){if(null==e)return{};var o,a,n=function(e,t){if(null==e)return{};var o,a,n={},r=Object.keys(e);for(a=0;a<r.length;a++)o=r[a],t.indexOf(o)>=0||(n[o]=e[o]);return n}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)o=r[a],t.indexOf(o)>=0||Object.prototype.propertyIsEnumerable.call(e,o)&&(n[o]=e[o])}return n}var p=n.a.createContext({}),d=function(e){var t=n.a.useContext(p),o=t;return e&&(o="function"==typeof e?e(t):i(i({},t),e)),o},c=function(e){var t=d(e.components);return n.a.createElement(p.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.a.createElement(n.a.Fragment,{},t)}},b=n.a.forwardRef((function(e,t){var o=e.components,a=e.mdxType,r=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),c=d(o),b=a,m=c["".concat(l,".").concat(b)]||c[b]||u[b]||r;return o?n.a.createElement(m,i(i({ref:t},p),{},{components:o})):n.a.createElement(m,i({ref:t},p))}));function m(e,t){var o=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=o.length,l=new Array(r);l[0]=b;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i.mdxType="string"==typeof e?e:a,l[1]=i;for(var p=2;p<r;p++)l[p]=o[p];return n.a.createElement.apply(null,l)}return n.a.createElement.apply(null,o)}b.displayName="MDXCreateElement"}}]);